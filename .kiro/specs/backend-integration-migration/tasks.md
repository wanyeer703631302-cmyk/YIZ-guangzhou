# 实施计划：后端集成迁移

## 概述

本实施计划将旧网页（YIZ-guangzhou）的后端服务、数据库配置和Vercel部署配置迁移到当前的前端应用中，实现完整的全栈应用。实施将按照依赖关系逐步进行，确保每个阶段都可以独立验证。

## 任务列表

- [x] 1. 项目结构设置和配置文件
  - [x] 1.1 创建项目目录结构
    - 创建 `api/` 目录用于Serverless Functions
    - 创建 `lib/` 目录用于共享库
    - 创建 `prisma/` 目录用于数据库配置
    - _需求: 6.1, 6.2_

  - [x] 1.2 配置环境变量模板
    - 创建 `.env.example` 文件，包含所有必需的环境变量
    - 添加 DATABASE_URL、Cloudinary配置、JWT_SECRET等
    - 为每个配置项添加说明注释
    - 更新 `.gitignore` 排除 `.env` 文件
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

  - [x] 1.3 配置根目录package.json
    - 创建统一的 `package.json` 管理依赖
    - 添加开发、构建和测试脚本
    - 配置Prisma相关脚本
    - _需求: 6.2, 6.3, 2.5_

- [x] 2. 数据库配置和Prisma设置
  - [x] 2.1 创建Prisma schema文件
    - 在 `prisma/schema.prisma` 中定义所有数据模型
    - 包含User、Asset、Folder、Tag、Like、Favorite等模型
    - 配置所有关系和索引
    - _需求: 2.1, 2.2, 2.3_

  - [x] 2.2 创建Prisma客户端工具
    - 在 `lib/prisma.ts` 中创建Prisma客户端单例
    - 实现连接池管理
    - 添加错误处理
    - _需求: 2.1_

  - [ ]* 2.3 编写数据模型单元测试
    - 测试Prisma客户端初始化
    - 测试数据库连接
    - _需求: 2.1_

- [x] 3. 共享库和工具模块
  - [x] 3.1 实现认证工具模块
    - 在 `lib/auth.ts` 中创建JWT令牌生成和验证函数
    - 实现 `withAuth` 中间件用于保护API端点
    - 实现 `generateToken` 函数
    - _需求: 10.8, 10.4_

  - [ ]* 3.2 编写认证工具的属性测试
    - **属性 9: 后端令牌验证**
    - **验证需求: 10.8**
    - 测试无效令牌返回401状态码
    - _需求: 10.8_

  - [x] 3.3 配置Cloudinary服务
    - 在 `lib/cloudinary.ts` 中配置Cloudinary客户端
    - 实现图片上传辅助函数
    - _需求: 1.3_

  - [ ]* 3.4 编写Cloudinary配置验证测试
    - 测试配置正确性
    - 测试连接可用性
    - _需求: 1.3, 12.5_

- [x] 4. 后端API端点实现 - 健康检查和认证
  - [x] 4.1 实现健康检查端点
    - 创建 `api/health.ts` 实现 GET /api/health
    - 检查数据库连接状态
    - 检查Cloudinary配置状态
    - 返回标准化的健康状态响应
    - _需求: 1.5, 12.3, 12.4, 12.6_

  - [ ]* 4.2 编写健康检查的属性测试
    - **属性 13: 健康检查响应格式**
    - **验证需求: 12.6**
    - 验证响应包含status和services字段
    - _需求: 12.6_

  - [x] 4.3 实现用户注册端点
    - 创建 `api/auth.ts` 实现 POST /api/auth/register
    - 验证输入数据（邮箱、密码、姓名）
    - 密码加密存储
    - 生成JWT令牌
    - _需求: 10.3, 10.4_

  - [x] 4.4 实现用户登录端点
    - 在 `api/auth.ts` 中实现 POST /api/auth/login
    - 验证用户凭据
    - 生成并返回JWT令牌
    - _需求: 10.3, 10.4_

  - [x] 4.5 实现会话验证端点
    - 在 `api/auth.ts` 中实现 GET /api/auth/session
    - 使用 `withAuth` 中间件保护端点
    - 返回当前用户信息
    - _需求: 10.8_

  - [ ]* 4.6 编写认证端点单元测试
    - 测试注册成功和失败场景
    - 测试登录成功和失败场景
    - 测试会话验证
    - _需求: 10.3, 10.4, 10.8_

- [x] 5. 后端API端点实现 - 资源管理
  - [x] 5.1 实现获取资源列表端点
    - 创建 `api/assets.ts` 实现 GET /api/assets
    - 支持分页参数（page, limit）
    - 支持文件夹筛选（folderId）
    - 返回资源列表和总数
    - _需求: 4.3, 4.4, 9.1_

  - [ ]* 5.2 编写资源列表的属性测试
    - **属性 2: 文件夹筛选正确性**
    - **验证需求: 4.4**
    - 验证筛选后的资源都属于指定文件夹
    - _需求: 4.4_

  - [x] 5.3 实现图片上传端点
    - 创建 `api/upload.ts` 实现 POST /api/upload
    - 使用 `withAuth` 中间件保护端点
    - 配置Multer处理文件上传
    - 验证文件大小不超过10MB
    - 验证文件类型为图片格式
    - 上传到Cloudinary并保存记录到数据库
    - _需求: 11.4, 11.8, 11.9, 1.3_

  - [ ]* 5.4 编写文件验证的属性测试
    - **属性 11: 文件大小验证**
    - **验证需求: 11.8**
    - **属性 12: 文件类型验证**
    - **验证需求: 11.9**
    - 测试大文件被拒绝
    - 测试非图片文件被拒绝
    - _需求: 11.8, 11.9_

- [x] 6. 后端API端点实现 - 交互功能
  - [x] 6.1 实现点赞功能端点
    - 创建 `api/likes.ts` 实现 POST /api/likes
    - 创建 `api/likes.ts` 实现 DELETE /api/likes/:id
    - 使用 `withAuth` 中间件保护端点
    - 保存点赞记录到数据库
    - _需求: 8.1, 8.4, 8.5_

  - [ ]* 6.2 编写点赞持久化的属性测试
    - **属性 3: 点赞持久化**
    - **验证需求: 8.1, 8.3**
    - 验证点赞记录被保存并可检索
    - _需求: 8.1, 8.3_

  - [x] 6.3 实现收藏功能端点
    - 创建 `api/favorites.ts` 实现 POST /api/favorites
    - 创建 `api/favorites.ts` 实现 DELETE /api/favorites/:id
    - 使用 `withAuth` 中间件保护端点
    - 保存收藏记录到数据库
    - _需求: 8.2, 8.6, 8.7_

  - [ ]* 6.4 编写收藏持久化的属性测试
    - **属性 4: 收藏持久化**
    - **验证需求: 8.2, 8.3**
    - 验证收藏记录被保存并可检索
    - _需求: 8.2, 8.3_

  - [x] 6.5 实现用户交互数据端点
    - 在 `api/assets.ts` 中实现 GET /api/user/interactions
    - 使用 `withAuth` 中间件保护端点
    - 返回用户的所有点赞和收藏记录
    - _需求: 8.3, 8.8_

  - [ ]* 6.6 编写API端点可用性测试
    - **属性 5: 必需API端点可用性**
    - **验证需求: 8.4, 8.5, 8.6, 8.7, 8.8**
    - 验证所有端点响应正确的HTTP方法
    - _需求: 8.4, 8.5, 8.6, 8.7, 8.8_

- [ ] 7. 检查点 - 后端API验证
  - 确保所有API端点正常工作，数据库连接成功，如有问题请询问用户

- [x] 8. 前端服务层实现
  - [x] 8.1 创建TypeScript类型定义
    - 在 `app/src/types/api.ts` 中定义所有API相关类型
    - 包含User、Asset、Folder、Tag、Like、Favorite等接口
    - 定义ApiResponse泛型接口
    - _需求: 4.1_

  - [x] 8.2 实现API客户端核心类
    - 在 `app/src/services/api.ts` 中创建ApiClient类
    - 实现通用的request方法处理HTTP请求
    - 实现令牌管理（从localStorage读取和存储）
    - 实现错误处理和标准化响应
    - _需求: 4.1, 4.6_

  - [ ]* 8.3 编写API客户端错误处理的属性测试
    - **属性 1: API错误响应格式**
    - **验证需求: 4.6**
    - 验证所有失败请求返回标准化错误格式
    - _需求: 4.6_

  - [x] 8.4 实现资源管理API方法
    - 在ApiClient中实现 `getAssets` 方法
    - 在ApiClient中实现 `uploadAsset` 方法
    - 支持分页和筛选参数
    - _需求: 4.2, 4.3, 4.4_

  - [x] 8.5 实现认证API方法
    - 在ApiClient中实现 `login` 方法
    - 在ApiClient中实现 `register` 方法
    - 在ApiClient中实现 `getSession` 方法
    - 在ApiClient中实现 `logout` 方法
    - 成功认证后自动存储令牌
    - _需求: 10.4, 10.5_

  - [ ]* 8.6 编写认证令牌存储的属性测试
    - **属性 7: 认证令牌存储**
    - **验证需求: 10.5**
    - 验证成功登录后令牌被存储到localStorage
    - _需求: 10.5_

  - [ ]* 8.7 编写认证请求头的属性测试
    - **属性 8: 认证请求头**
    - **验证需求: 10.6**
    - 验证需要认证的请求包含Authorization头
    - _需求: 10.6_

  - [x] 8.8 实现交互功能API方法
    - 在ApiClient中实现 `createLike` 方法
    - 在ApiClient中实现 `deleteLike` 方法
    - 在ApiClient中实现 `createFavorite` 方法
    - 在ApiClient中实现 `deleteFavorite` 方法
    - 在ApiClient中实现 `getUserInteractions` 方法
    - _需求: 8.1, 8.2_

  - [x] 8.9 实现健康检查API方法
    - 在ApiClient中实现 `checkHealth` 方法
    - _需求: 12.7_

- [x] 9. 前端UI组件实现 - 认证
  - [x] 9.1 创建登录组件
    - 在 `app/src/components/auth/LoginForm.tsx` 中创建登录表单
    - 实现表单验证
    - 调用apiClient.login进行认证
    - 显示加载状态和错误消息
    - _需求: 10.2, 10.4_

  - [x] 9.2 创建注册组件
    - 在 `app/src/components/auth/RegisterForm.tsx` 中创建注册表单
    - 实现表单验证
    - 调用apiClient.register进行注册
    - 显示加载状态和错误消息
    - _需求: 10.3, 10.4_

  - [x] 9.3 创建认证上下文
    - 在 `app/src/contexts/AuthContext.tsx` 中创建认证上下文
    - 管理用户登录状态
    - 提供登录、注册、登出方法
    - 在应用启动时验证会话
    - _需求: 10.4, 10.5, 10.7_

  - [ ]* 9.4 编写认证组件单元测试
    - 测试登录表单提交
    - 测试注册表单提交
    - 测试错误显示
    - _需求: 10.2, 10.3_

- [x] 10. 前端UI组件实现 - 图片上传
  - [x] 10.1 创建图片上传组件
    - 在 `app/src/components/upload/ImageUpload.tsx` 中创建上传组件
    - 支持拖拽上传和点击选择
    - 显示上传预览
    - 显示上传进度
    - 调用apiClient.uploadAsset上传图片
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

  - [x] 10.2 实现上传成功后的列表刷新
    - 上传成功后调用apiClient.getAssets刷新列表
    - 显示成功提示
    - _需求: 11.6_

  - [ ]* 10.3 编写上传后列表更新的属性测试
    - **属性 10: 上传成功后列表更新**
    - **验证需求: 11.6**
    - 验证上传后新资源出现在列表中
    - _需求: 11.6_

  - [x] 10.4 实现上传错误处理
    - 显示上传失败错误消息
    - 提供重试选项
    - _需求: 11.7_

  - [ ]* 10.5 编写上传组件单元测试
    - 测试文件选择
    - 测试拖拽上传
    - 测试错误处理
    - _需求: 11.1, 11.2, 11.7_

- [x] 11. 前端数据集成 - 资源加载
  - [x] 11.1 修改现有组件使用API数据
    - 在应用初始化时调用apiClient.getAssets获取资源列表
    - 使用API返回的url和thumbnailUrl替换硬编码数据
    - 保留现有的3D网格畸变和鼠标跟随效果
    - _需求: 9.1, 9.2, 9.3, 9.4, 6.5_

  - [ ]* 11.2 编写API数据使用的属性测试
    - **属性 6: API数据使用**
    - **验证需求: 9.2, 9.3**
    - 验证前端使用API返回的URL而非硬编码数据
    - _需求: 9.2, 9.3_

  - [x] 11.3 实现空状态和错误状态
    - API返回空列表时显示友好提示
    - API请求失败时显示错误提示和重试按钮
    - _需求: 9.5, 9.6_

  - [ ]* 11.4 编写资源加载单元测试
    - 测试成功加载场景
    - 测试空状态显示
    - 测试错误状态显示
    - _需求: 9.1, 9.5, 9.6_

- [x] 12. 前端交互功能集成
  - [x] 12.1 集成点赞功能
    - 修改点赞按钮调用apiClient.createLike
    - 取消点赞时调用apiClient.deleteLike
    - 页面加载时从apiClient.getUserInteractions获取点赞状态
    - 更新UI显示点赞状态
    - _需求: 8.1, 8.3_

  - [x] 12.2 集成收藏功能
    - 修改收藏按钮调用apiClient.createFavorite
    - 取消收藏时调用apiClient.deleteFavorite
    - 页面加载时从apiClient.getUserInteractions获取收藏状态
    - 更新UI显示收藏状态
    - _需求: 8.2, 8.3_

  - [ ]* 12.3 编写交互功能集成测试
    - 测试点赞和取消点赞流程
    - 测试收藏和取消收藏流程
    - 测试状态持久化
    - _需求: 8.1, 8.2, 8.3_

- [ ] 13. 检查点 - 前端集成验证
  - 确保前端所有功能正常工作，API调用成功，如有问题请询问用户

- [x] 14. Vercel部署配置
  - [x] 14.1 创建vercel.json配置文件
    - 配置前端构建命令和输出目录
    - 配置API路由重写规则
    - 配置环境变量引用
    - 配置Serverless Functions设置
    - _需求: 5.1, 5.2, 5.3, 5.4_

  - [x] 14.2 配置package.json构建脚本
    - 添加Vercel构建命令
    - 添加Prisma生成和迁移脚本
    - 配置postinstall脚本
    - _需求: 5.2, 2.5_

  - [ ]* 14.3 编写部署配置验证测试
    - 验证vercel.json格式正确
    - 验证构建脚本可执行
    - _需求: 5.1, 5.2_

- [x] 15. 配置验证和启动检查
  - [x] 15.1 实现后端启动时配置验证
    - 在后端启动时验证所有必需环境变量
    - 缺失配置时记录错误并拒绝启动
    - 测试数据库连接
    - 测试Cloudinary连接
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

  - [x] 15.2 实现前端启动时健康检查
    - 在应用启动时调用健康检查端点
    - 后端不可用时显示维护模式提示
    - _需求: 12.7, 12.8_

  - [ ]* 15.3 编写配置验证单元测试
    - 测试缺失环境变量时的行为
    - 测试数据库连接失败时的行为
    - _需求: 12.1, 12.2, 12.3, 12.4_

- [x] 16. 文档更新
  - [x] 16.1 更新README.md
    - 添加项目介绍和技术栈说明
    - 说明新的项目结构
    - 添加环境变量配置说明
    - 添加本地开发环境启动步骤
    - 添加Vercel部署指南
    - _需求: 6.6, 7.2, 7.3, 7.4, 7.5_

  - [x] 16.2 创建部署说明文档
    - 创建详细的Vercel环境变量配置步骤
    - 说明数据库迁移流程
    - 说明Cloudinary配置步骤
    - _需求: 5.6_

  - [x] 16.3 创建Git仓库配置说明
    - 更新.gitignore文件
    - 提供git初始化和首次提交的命令说明
    - _需求: 7.1, 7.6_

- [ ] 17. 最终检查点
  - 运行所有测试确保通过，验证本地开发环境可以正常启动，如有问题请询问用户

## 注意事项

- 标记 `*` 的任务为可选测试任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求编号以确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
